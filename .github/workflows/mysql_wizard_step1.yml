name: "MySQL - Wizard Passo 1: ConfiguraÃ§Ã£o BÃ¡sica"

on:
  workflow_dispatch:
    inputs:
      ambiente:
        description: "Ambiente"
        required: true
        type: choice
        options: [development, staging, production]
      email:
        description: "Email do usuÃ¡rio (ex: nome@empresa.com)"
        required: true
        type: string
      host:
        description: "Endpoint do banco MySQL"
        required: true
        type: string
      database:
        description: "Nome do banco de dados"
        required: true
        type: string
      region:
        description: "RegiÃ£o AWS"
        required: true
        type: string
      port:
        description: "Porta do banco"
        required: true
        default: "3306"
        type: string

permissions:
  contents: write

jobs:
  # ValidaÃ§Ã£o de seguranÃ§a obrigatÃ³ria ANTES de qualquer operaÃ§Ã£o
  security-validation:
    name: ğŸ›¡ï¸ ValidaÃ§Ã£o de SeguranÃ§a
    uses: ./.github/workflows/reusable-security-check.yml
    with:
      workflow_name: "MySQL - Wizard Passo 1: ConfiguraÃ§Ã£o BÃ¡sica"
      operation_type: "mysql"

  # Job principal - sÃ³ executa se a validaÃ§Ã£o de seguranÃ§a passar
  gerar_arquivo_temporario:
    name: "ğŸ“ Gerar ConfiguraÃ§Ã£o TemporÃ¡ria"
    runs-on: ubuntu-24.04
    
    # DEPENDÃŠNCIA OBRIGATÃ“RIA da validaÃ§Ã£o de seguranÃ§a
    needs: security-validation
    if: needs.security-validation.outputs.is_secure == 'true'
    
    steps:
      - name: Security Confirmation
        run: |
          echo "ğŸ›¡ï¸ VALIDAÃ‡ÃƒO DE SEGURANÃ‡A APROVADA"
          echo "================================="
          echo "ğŸ¯ Status: ${{ needs.security-validation.outputs.security_status }}"
          echo "ğŸ”“ Prosseguindo com operaÃ§Ãµes MySQL Wizard seguras..."
          echo ""

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validar Entrada
        run: |
          echo "ğŸ” Validando dados bÃ¡sicos..."
          
          if ! echo "${{ github.event.inputs.email }}" | grep -E '^[^@]+@[^@]+\.[^@]+$'; then
            echo "âŒ Email invÃ¡lido"
            exit 1
          fi
          
          if ! echo "${{ github.event.inputs.port }}" | grep -E '^[0-9]+$'; then
            echo "âŒ Porta deve ser numÃ©rica"
            exit 1
          fi
          
          echo "âœ… Dados bÃ¡sicos vÃ¡lidos"

      - name: Gerar Arquivo TemporÃ¡rio
        id: gerar_temp
        run: |
          session_id="mysql-wizard-$(date +%s)-${{ github.run_id }}"
          temp_dir="wizard-temp"
          temp_file="${temp_dir}/${session_id}.yml"
          
          echo "ğŸ“ Criando diretÃ³rio temporÃ¡rio: $temp_dir"
          mkdir -p "$temp_dir"
          
          echo "ğŸ“„ Gerando arquivo temporÃ¡rio: $temp_file"
          
          cat > "$temp_file" << 'EOF'
          # Arquivo temporÃ¡rio do MySQL Wizard - Step 1
          # Gerado em: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Session ID: $session_id
          
          dados_basicos:
            ambiente: "${{ github.event.inputs.ambiente }}"
            email: "${{ github.event.inputs.email }}"
            host: "${{ github.event.inputs.host }}"
            database: "${{ github.event.inputs.database }}"
            region: "${{ github.event.inputs.region }}"
            port: "${{ github.event.inputs.port }}"
            engine: "mysql"
            timestamp: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            workflow_run_id: "${{ github.run_id }}"
            workflow_run_number: "${{ github.run_number }}"
          
          # As permissÃµes serÃ£o adicionadas no Step 2
          permissoes: {}
          EOF
          
          echo "session_id=$session_id" >> $GITHUB_OUTPUT
          echo "temp_file=$temp_file" >> $GITHUB_OUTPUT
          echo "temp_dir=$temp_dir" >> $GITHUB_OUTPUT

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit Arquivo TemporÃ¡rio
        run: |
          git add "${{ steps.gerar_temp.outputs.temp_file }}"
          git commit -m "ğŸ§™â€â™‚ï¸ MySQL Wizard Step 1: ConfiguraÃ§Ã£o bÃ¡sica para ${{ github.event.inputs.email }}"
          git push origin main

      - name: InstruÃ§Ãµes para PrÃ³ximo Passo
        run: |
          echo "âœ… Step 1 concluÃ­do com sucesso!"
          echo ""
          echo "ğŸ“‹ Dados configurados:"
          echo "  ğŸ‘¤ Email: ${{ github.event.inputs.email }}"
          echo "  ğŸŒ Ambiente: ${{ github.event.inputs.ambiente }}"
          echo "  ğŸ—„ï¸ Database: ${{ github.event.inputs.database }}"
          echo "  ğŸ”Œ Host: ${{ github.event.inputs.host }}"
          echo "  ğŸŒ RegiÃ£o: ${{ github.event.inputs.region }}"
          echo "  ğŸšª Porta: ${{ github.event.inputs.port }}"
          echo ""
          echo "ğŸ”„ Para continuar:"
          echo "1. VÃ¡ para GitHub Actions"
          echo "2. Execute 'MySQL - Wizard Passo 2: PermissÃµes'"
          echo "3. Use o Session ID: ${{ steps.gerar_temp.outputs.session_id }}"
          echo ""
          echo "ğŸ“ Arquivo temporÃ¡rio criado: ${{ steps.gerar_temp.outputs.temp_file }}" 