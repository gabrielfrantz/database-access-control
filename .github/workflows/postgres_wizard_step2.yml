name: "PostgreSQL/Aurora - Wizard Passo 2: SeleÃ§Ã£o de PermissÃµes"

on:
  workflow_dispatch:
    inputs:
      session_id:
        description: "Session ID do Step 1 (ex: postgres-wizard-1734567890-12345)"
        required: true
        type: string
      
      # ConfiguraÃ§Ã£o de Schema e Tabelas
      schema_name:
        description: "ğŸ“‚ Nome do Schema a aplicar as permissÃµes"
        required: true
        type: string
      tables_list:
        description: "ğŸ“‹ Tabelas especÃ­ficas (separar por vÃ­rgula) - deixe vazio para aplicar em TODAS"
        required: false
        type: string
        
      # PermissÃµes DML (Data Manipulation Language)
      schema_select:
        description: "ğŸ“‹ SELECT - Consultar dados no schema"
        required: false
        type: boolean
        default: false
      schema_insert:
        description: "â• INSERT - Inserir dados no schema"  
        required: false
        type: boolean
        default: false
      schema_update:
        description: "âœï¸ UPDATE - Atualizar dados no schema"
        required: false
        type: boolean
        default: false
      schema_delete:
        description: "ğŸ—‘ï¸ DELETE - Deletar dados no schema"
        required: false
        type: boolean
        default: false
      
      # PermissÃµes DDL (Data Definition Language)
      schema_create:
        description: "ğŸ—ï¸ CREATE - Criar objetos no schema"
        required: false
        type: boolean
        default: false
      schema_execute:
        description: "ğŸ”§ EXECUTE - Executar funÃ§Ãµes no schema"
        required: false
        type: boolean
        default: false
      schema_connect:
        description: "ğŸ”Œ CONNECT - Conectar ao banco de dados"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: write

jobs:
  # ValidaÃ§Ã£o de seguranÃ§a obrigatÃ³ria ANTES de qualquer operaÃ§Ã£o
  security-validation:
    name: ğŸ›¡ï¸ ValidaÃ§Ã£o de SeguranÃ§a
    uses: ./.github/workflows/reusable-security-check.yml
    with:
      workflow_name: "PostgreSQL/Aurora - Wizard Passo 2: SeleÃ§Ã£o de PermissÃµes"
      operation_type: "postgresql"

  # Job principal - sÃ³ executa se a validaÃ§Ã£o de seguranÃ§a passar
  processar_permissoes:
    name: "ğŸ§™â€â™‚ï¸ Processar PermissÃµes PostgreSQL"
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    # DEPENDÃŠNCIA OBRIGATÃ“RIA da validaÃ§Ã£o de seguranÃ§a
    needs: security-validation
    if: needs.security-validation.outputs.is_secure == 'true'

    steps:
      - name: Security Confirmation
        run: |
          echo "ğŸ›¡ï¸ VALIDAÃ‡ÃƒO DE SEGURANÃ‡A APROVADA"
          echo "================================="
          echo "ğŸ¯ Status: ${{ needs.security-validation.outputs.security_status }}"
          echo "ğŸ”“ Prosseguindo com operaÃ§Ãµes PostgreSQL/Aurora Wizard seguras..."
          echo ""

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validar Session ID
        run: |
          echo "ğŸ” Validando Session ID: ${{ github.event.inputs.session_id }}"
          
          if ! echo "${{ github.event.inputs.session_id }}" | grep -E '^postgres-wizard-[0-9]+-[0-9]+$'; then
            echo "âŒ Session ID invÃ¡lido. Formato esperado: postgres-wizard-TIMESTAMP-RUNID"
            echo "ğŸ’¡ Execute primeiro o 'PostgreSQL/Aurora - Wizard Passo 1' para obter um Session ID vÃ¡lido"
            exit 1
          fi
          
          temp_file="wizard-temp/${{ github.event.inputs.session_id }}.yml"
          if [ ! -f "$temp_file" ]; then
            echo "âŒ Arquivo temporÃ¡rio nÃ£o encontrado: $temp_file"
            echo "ğŸ’¡ Certifique-se de que o Step 1 foi executado com sucesso"
            exit 1
          fi
          
          echo "âœ… Session ID vÃ¡lido e arquivo temporÃ¡rio encontrado"

      - name: Validar Entrada
        run: |
          echo "ğŸ” Validando entrada de dados..."
          
          # Validar schema name
          if [ -z "${{ github.event.inputs.schema_name }}" ]; then
            echo "âŒ Nome do schema Ã© obrigatÃ³rio"
            exit 1
          fi
          
          echo "âœ… ValidaÃ§Ã£o de entrada concluÃ­da"

      - name: Ler Dados do Arquivo TemporÃ¡rio
        id: ler_temp
        run: |
          temp_file="wizard-temp/${{ github.event.inputs.session_id }}.yml"
          
          echo "ğŸ“– Lendo dados bÃ¡sicos do arquivo temporÃ¡rio..."
          
          # Extrair dados usando grep e sed
          ambiente=$(grep "ambiente:" "$temp_file" | sed 's/.*ambiente: "\(.*\)"/\1/')
          email=$(grep "email:" "$temp_file" | sed 's/.*email: "\(.*\)"/\1/')
          host=$(grep "host:" "$temp_file" | sed 's/.*host: "\(.*\)"/\1/')
          database=$(grep "database:" "$temp_file" | sed 's/.*database: "\(.*\)"/\1/')
          region=$(grep "region:" "$temp_file" | sed 's/.*region: "\(.*\)"/\1/')
          port=$(grep "port:" "$temp_file" | sed 's/.*port: "\(.*\)"/\1/')
          engine=$(grep "engine:" "$temp_file" | sed 's/.*engine: "\(.*\)"/\1/')
          
          echo "ambiente=$ambiente" >> $GITHUB_OUTPUT
          echo "email=$email" >> $GITHUB_OUTPUT
          echo "host=$host" >> $GITHUB_OUTPUT
          echo "database=$database" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT
          echo "port=$port" >> $GITHUB_OUTPUT
          echo "engine=$engine" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Dados bÃ¡sicos recuperados:"
          echo "  ğŸ‘¤ Email: $email"
          echo "  ğŸŒ Ambiente: $ambiente"
          echo "  ğŸ—„ï¸ Database: $database"
          echo "  ğŸ˜ Engine: $engine"

      - name: Processar Lista de Tabelas
        id: process_tables
        run: |
          tables_input="${{ github.event.inputs.tables_list }}"
          
          if [ -z "$tables_input" ]; then
            echo "ğŸ“‚ Nenhuma tabela especÃ­fica fornecida - aplicarÃ¡ permissÃµes em TODO o schema"
            echo "apply_to_all_schema=true" >> $GITHUB_OUTPUT
            echo "tables_array=" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“‹ Tabelas especÃ­ficas fornecidas: $tables_input"
            # Remover espaÃ§os e converter vÃ­rgulas em array
            tables_clean=$(echo "$tables_input" | tr -d ' ')
            echo "apply_to_all_schema=false" >> $GITHUB_OUTPUT
            echo "tables_array=$tables_clean" >> $GITHUB_OUTPUT
            echo "ğŸ¯ AplicarÃ¡ permissÃµes nas tabelas: $tables_clean"
          fi

      - name: Construir JSON de PermissÃµes
        id: build_permissions
        run: |
          echo "ğŸ—ï¸ Construindo JSON a partir dos checkboxes selecionados..."
          
          # Construir array de permissÃµes selecionadas
          perms=()
          
          # DML Permissions
          [ "${{ github.event.inputs.schema_select }}" == "true" ] && perms+=("\"SELECT\"")
          [ "${{ github.event.inputs.schema_insert }}" == "true" ] && perms+=("\"INSERT\"")
          [ "${{ github.event.inputs.schema_update }}" == "true" ] && perms+=("\"UPDATE\"")
          [ "${{ github.event.inputs.schema_delete }}" == "true" ] && perms+=("\"DELETE\"")
          
          # DDL e outras permissÃµes
          [ "${{ github.event.inputs.schema_create }}" == "true" ] && perms+=("\"CREATE\"")
          [ "${{ github.event.inputs.schema_trigger }}" == "true" ] && perms+=("\"TRIGGER\"")
          [ "${{ github.event.inputs.schema_execute }}" == "true" ] && perms+=("\"EXECUTE\"")
          [ "${{ github.event.inputs.schema_connect }}" == "true" ] && perms+=("\"CONNECT\"")
          
          # Verificar se nenhuma permissÃ£o foi selecionada
          if [ ${#perms[@]} -eq 0 ]; then
            echo "âš ï¸ Nenhuma permissÃ£o especÃ­fica selecionada - usando ALL PRIVILEGES"
            perms=("\"ALL PRIVILEGES\"")
          fi
          
          # Unir permissÃµes com vÃ­rgula
          IFS=','
          permissions_list="${perms[*]}"
          
          # Construir JSON baseado no tipo de aplicaÃ§Ã£o
          if [ "${{ steps.process_tables.outputs.apply_to_all_schema }}" == "true" ]; then
            # Aplicar permissÃµes em todo o schema
            permissions_json="{\"schema_permissions\": {\"${{ github.event.inputs.schema_name }}\": [${permissions_list}]}}"
            echo "ğŸ¯ Aplicando permissÃµes em todo o schema: ${{ github.event.inputs.schema_name }}"
          else
            # Aplicar permissÃµes em tabelas especÃ­ficas
            permissions_json="{\"table_permissions\": {"
            
            # Converter lista de tabelas em entradas JSON
            IFS=','
            tables_array=(${{ steps.process_tables.outputs.tables_array }})
            table_entries=()
            
            for table in "${tables_array[@]}"; do
              table_entries+=("\"$table\": [${permissions_list}]")
            done
            
            IFS=','
            permissions_json+="${table_entries[*]}"
            permissions_json+="}}"
            
            echo "ğŸ¯ Aplicando permissÃµes nas tabelas especÃ­ficas: ${{ steps.process_tables.outputs.tables_array }}"
          fi
          
          echo "ğŸ” PermissÃµes selecionadas: ${perms[*]}"
          echo "permissions_json=$permissions_json" >> $GITHUB_OUTPUT
          echo "ğŸ¯ JSON final construÃ­do: $permissions_json"

      - name: Instalar DependÃªncias Python
        run: pip install pyyaml

      - name: Configurar Paths de Arquivos
        id: setup_paths
        run: |
          ambiente="${{ steps.ler_temp.outputs.ambiente }}"
          email="${{ steps.ler_temp.outputs.email }}"
          database="${{ steps.ler_temp.outputs.database }}"
          engine="${{ steps.ler_temp.outputs.engine }}"
          
          # Estrutura final: ambiente/postgres|aurora/database/usuario.yml
          directory="users-access-requests/${ambiente}/${engine}/${database}"
          file_path="${directory}/${email}.yml"
          
          # Nome da branch
          username="$(echo ${email} | cut -d '@' -f1)"
          branch_name="postgres-wizard-${username}-${database}-$(date +%s)"
          
          echo "directory=$directory" >> $GITHUB_OUTPUT
          echo "file_path=$file_path" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ Estrutura de destino:"
          echo "  ğŸ“‚ DiretÃ³rio: $directory"
          echo "  ğŸ“„ Arquivo: $file_path"
          echo "  ğŸŒ¿ Branch: $branch_name"

      - name: Gerar Arquivo Final
        env:
          INPUT_AMBIENTE: ${{ steps.ler_temp.outputs.ambiente }}
          INPUT_HOST: ${{ steps.ler_temp.outputs.host }}
          INPUT_EMAIL: ${{ steps.ler_temp.outputs.email }}
          INPUT_DATABASE: ${{ steps.ler_temp.outputs.database }}
          INPUT_ENGINE: ${{ steps.ler_temp.outputs.engine }}
          INPUT_REGION: ${{ steps.ler_temp.outputs.region }}
          INPUT_PORT: ${{ steps.ler_temp.outputs.port }}
          INPUT_SCHEMA_NAME: ${{ github.event.inputs.schema_name }}
          INPUT_PERMISSIONS_JSON: ${{ steps.build_permissions.outputs.permissions_json }}
          INPUT_REVOGAR: "false"
          INPUT_REMOVER_PERMISSOES: "false"
        run: |
          echo "ğŸ”§ Gerando arquivo final de permissÃµes..."
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p "${{ steps.setup_paths.outputs.directory }}"
          
          # Usar o script merge_permissions.py para gerar o arquivo final
          python3 scripts/merge_permissions.py "${{ steps.setup_paths.outputs.file_path }}" '${{ steps.build_permissions.outputs.permissions_json }}'
          
          echo "âœ… Arquivo final gerado: ${{ steps.setup_paths.outputs.file_path }}"

      - name: Limpar Arquivo TemporÃ¡rio
        run: |
          temp_file="wizard-temp/${{ github.event.inputs.session_id }}.yml"
          
          echo "ğŸ§¹ Removendo arquivo temporÃ¡rio: $temp_file"
          rm -f "$temp_file"
          
          # Remover diretÃ³rio se estiver vazio
          if [ -d "wizard-temp" ] && [ ! "$(ls -A wizard-temp)" ]; then
            rmdir wizard-temp
            echo "ğŸ“ DiretÃ³rio wizard-temp removido (vazio)"
          fi

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit das AlteraÃ§Ãµes
        run: |
          # Adicionar arquivo final
          git add "${{ steps.setup_paths.outputs.file_path }}"
          
          # Remover arquivo temporÃ¡rio do git se existir
          temp_file="wizard-temp/${{ github.event.inputs.session_id }}.yml"
          if git ls-files --error-unmatch "$temp_file" > /dev/null 2>&1; then
            git rm "$temp_file" 2>/dev/null || true
          fi
          
          # Remover diretÃ³rio vazio se aplicÃ¡vel
          if [ -d "wizard-temp" ] && [ ! "$(ls -A wizard-temp)" ]; then
            git rm -rf wizard-temp 2>/dev/null || true
          fi
          
          # Commit
          git commit -m "ğŸ§™â€â™‚ï¸ PostgreSQL/Aurora Wizard: Adicionar permissÃµes para ${{ steps.ler_temp.outputs.email }} no banco ${{ steps.ler_temp.outputs.database }}"

      - name: Criar Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          branch: ${{ steps.setup_paths.outputs.branch_name }}
          base: main
          title: "ğŸ§™â€â™‚ï¸ PostgreSQL/Aurora Wizard: Acesso para ${{ steps.ler_temp.outputs.email }}"
          body: |
            ## ğŸ§™â€â™‚ï¸ PostgreSQL/Aurora Wizard - SolicitaÃ§Ã£o de Acesso
            
            **ğŸ“‹ ConfiguraÃ§Ã£o BÃ¡sica (Step 1):**
            - ğŸ‘¤ **UsuÃ¡rio:** `${{ steps.ler_temp.outputs.email }}`
            - ğŸŒ **Ambiente:** `${{ steps.ler_temp.outputs.ambiente }}`
            - ğŸ—„ï¸ **Banco:** `${{ steps.ler_temp.outputs.database }}`
            - ğŸ”Œ **Host:** `${{ steps.ler_temp.outputs.host }}`
            - ğŸšª **Porta:** `${{ steps.ler_temp.outputs.port }}`
            - ğŸŒ **RegiÃ£o:** `${{ steps.ler_temp.outputs.region }}`
            - ğŸ˜ **Engine:** `${{ steps.ler_temp.outputs.engine }}`
            
            **ğŸ¯ PermissÃµes Selecionadas (Step 2):**
            - ğŸ“‚ **Schema:** `${{ github.event.inputs.schema_name }}`
            - ğŸ“‹ **Tabelas:** ${{ github.event.inputs.tables_list || 'TODAS (schema completo)' }}
            - ğŸ¯ **Escopo:** ${{ steps.process_tables.outputs.apply_to_all_schema == 'true' && 'Schema completo' || 'Tabelas especÃ­ficas' }}
            
            **ğŸ” JSON de PermissÃµes:**
            ```json
            ${{ steps.build_permissions.outputs.permissions_json }}
            ```
            
            **ğŸ“Š Resumo das PermissÃµes:**
            ${{ github.event.inputs.schema_select == 'true' && '- âœ… SELECT (Consultar dados)' || '' }}
            ${{ github.event.inputs.schema_insert == 'true' && '- âœ… INSERT (Inserir dados)' || '' }}
            ${{ github.event.inputs.schema_update == 'true' && '- âœ… UPDATE (Atualizar dados)' || '' }}
            ${{ github.event.inputs.schema_delete == 'true' && '- âœ… DELETE (Deletar dados)' || '' }}
            ${{ github.event.inputs.schema_create == 'true' && '- âœ… CREATE (Criar objetos)' || '' }}
            ${{ github.event.inputs.schema_trigger == 'true' && '- âœ… TRIGGER (Gerenciar triggers)' || '' }}
            ${{ github.event.inputs.schema_execute == 'true' && '- âœ… EXECUTE (Executar funÃ§Ãµes)' || '' }}
            ${{ github.event.inputs.schema_connect == 'true' && '- âœ… CONNECT (Conectar ao banco)' || '' }}
            
            ---
            **âš ï¸ Importante:** ApÃ³s o merge, as permissÃµes serÃ£o aplicadas automaticamente no PostgreSQL/Aurora.
            
            **ğŸ§™â€â™‚ï¸ Session ID:** `${{ github.event.inputs.session_id }}`
          delete-branch: false

      - name: Mostrar Resultados
        run: |
          echo "ğŸ‰ PostgreSQL/Aurora Wizard concluÃ­do com sucesso!"
          echo ""
          echo "ğŸ“‹ Resumo da OperaÃ§Ã£o:"
          echo "  ğŸ‘¤ UsuÃ¡rio: ${{ steps.ler_temp.outputs.email }}"
          echo "  ğŸŒ Ambiente: ${{ steps.ler_temp.outputs.ambiente }}"
          echo "  ğŸ—„ï¸ Database: ${{ steps.ler_temp.outputs.database }}"
          echo "  ğŸ˜ Engine: ${{ steps.ler_temp.outputs.engine }}"
          echo "  ğŸ“‚ Schema: ${{ github.event.inputs.schema_name }}"
          echo "  ğŸ“‹ Tabelas: ${{ github.event.inputs.tables_list || 'TODAS (schema completo)' }}"
          echo "  ğŸ¯ Escopo: ${{ steps.process_tables.outputs.apply_to_all_schema == 'true' && 'Schema completo' || 'Tabelas especÃ­ficas' }}"
          echo "  ğŸ”Œ Host: ${{ steps.ler_temp.outputs.host }}"
          echo "  ğŸ“„ Arquivo criado: ${{ steps.setup_paths.outputs.file_path }}"
          echo "  ğŸ”— Pull Request: ${{ steps.create_pr.outputs.pull-request-url }}"
          echo ""
          echo "ğŸ”„ PrÃ³ximos passos:"
          echo "1. Revisar o Pull Request criado"
          echo "2. Aprovar e fazer merge"
          echo "3. As permissÃµes serÃ£o aplicadas automaticamente"
          echo ""
          echo "ğŸ§¹ Limpeza realizada:"
          echo "  âœ… Arquivo temporÃ¡rio removido"
          echo "  âœ… Arquivo final criado em: ${{ steps.setup_paths.outputs.file_path }}" 
