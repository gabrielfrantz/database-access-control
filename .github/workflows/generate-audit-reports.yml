name: Gerar relatÃ³rios

on:
  workflow_dispatch:
    inputs:
      report_type:
        description: "Tipo de relatÃ³rio"
        required: true
        type: choice
        options: 
          - "usuario-especifico"
          - "todos-usuarios"
        default: "usuario-especifico"
      user_email:
        description: "Email do usuÃ¡rio (obrigatÃ³rio apenas para relatÃ³rio especÃ­fico)"
        required: false
        type: string
      database_name:
        description: "Nome do banco especÃ­fico (opcional - deixe vazio para relatÃ³rio completo)"
        required: false
        type: string
      output_format:
        description: "Formato de saÃ­da"
        required: true
        type: choice
        options: [html, json]
        default: html

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ValidaÃ§Ã£o de seguranÃ§a obrigatÃ³ria
  security-validation:
    name: ðŸ›¡ï¸ ValidaÃ§Ã£o de SeguranÃ§a
    uses: ./.github/workflows/reusable-security-check.yml
    with:
      workflow_name: "Gerar relatÃ³rios"
      operation_type: "audit"

  generate-reports:
    name: ðŸ“Š Gerar RelatÃ³rios
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    needs: security-validation
    if: needs.security-validation.outputs.is_secure == 'true'

    steps:
      - name: Security Confirmation
        run: |
          echo "ðŸ›¡ï¸ VALIDAÃ‡ÃƒO DE SEGURANÃ‡A APROVADA"
          echo "================================="
          echo "ðŸŽ¯ Status: ${{ needs.security-validation.outputs.security_status }}"
          echo "ðŸ”“ Prosseguindo com geraÃ§Ã£o de relatÃ³rios..."

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install pyyaml

      - name: Validate Inputs
        run: |
          echo "ðŸ” Validando inputs do relatÃ³rio..."
          
          if [ "${{ github.event.inputs.report_type }}" == "usuario-especifico" ]; then
            if [ -z "${{ github.event.inputs.user_email }}" ]; then
              echo "âŒ Email do usuÃ¡rio Ã© obrigatÃ³rio para relatÃ³rio especÃ­fico"
              exit 1
            fi
          fi
          
          echo "âœ… Inputs validados"
          echo "ðŸ“Š Tipo: ${{ github.event.inputs.report_type }}"
          echo "ðŸ‘¤ UsuÃ¡rio: ${{ github.event.inputs.user_email || 'Todos os usuÃ¡rios' }}"
          echo "ðŸ—„ï¸ Banco: ${{ github.event.inputs.database_name || 'Todos os bancos' }}"
          echo "ðŸ“„ Formato: ${{ github.event.inputs.output_format }}"

      - name: Generate General Report (All Users)
        if: github.event.inputs.report_type == 'todos-usuarios'
        run: |
          echo "ðŸ” Gerando relatÃ³rio geral para todos os usuÃ¡rios..."
          
          # Gerar nome do arquivo baseado no formato
          timestamp=$(date +%Y%m%d-%H%M%S)
          
          if [ "${{ github.event.inputs.output_format }}" == "html" ]; then
            output_file="relatorio-geral-todos-usuarios-${timestamp}.html"
          else
            output_file="relatorio-geral-todos-usuarios-${timestamp}.json"
          fi
          
          echo "ðŸ“ Arquivo de saÃ­da: $output_file"
          
          # Executar geraÃ§Ã£o do relatÃ³rio geral
          if [ "${{ github.event.inputs.output_format }}" == "html" ]; then
            python scripts/generate_general_report.py --output "$output_file"
          else
            echo "âš ï¸ Formato JSON nÃ£o suportado para relatÃ³rio geral. Gerando em HTML..."
            python scripts/generate_general_report.py --output "${output_file%.json}.html"
          fi
          
          echo "âœ… RelatÃ³rio geral gerado com sucesso!"

      - name: Generate User Specific Report
        if: github.event.inputs.report_type == 'usuario-especifico'
        run: |
          echo "ðŸ” Gerando relatÃ³rio para usuÃ¡rio: ${{ github.event.inputs.user_email }}"
          
          # Determinar tipo de relatÃ³rio
          if [ -n "${{ github.event.inputs.database_name }}" ]; then
            report_subtype="especÃ­fico"
            database_param="--database ${{ github.event.inputs.database_name }}"
            output_suffix="${{ github.event.inputs.database_name }}"
          else
            report_subtype="completo"
            database_param=""
            output_suffix="completo"
          fi
          
          echo "ðŸ“Š Subtipo de relatÃ³rio: $report_subtype"
          
          # Gerar nome do arquivo baseado no formato
          timestamp=$(date +%Y%m%d-%H%M%S)
          user_clean=$(echo "${{ github.event.inputs.user_email }}" | sed 's/@/-at-/g' | sed 's/\./-/g')
          
          if [ "${{ github.event.inputs.output_format }}" == "html" ]; then
            output_file="relatorio-${user_clean}-${output_suffix}-${timestamp}.html"
          else
            output_file="relatorio-${user_clean}-${output_suffix}-${timestamp}.json"
          fi
          
          echo "ðŸ“ Arquivo de saÃ­da: $output_file"
          
          # Executar geraÃ§Ã£o do relatÃ³rio especÃ­fico
          python scripts/generate_audit_reports.py \
            --user "${{ github.event.inputs.user_email }}" \
            $database_param \
            --format ${{ github.event.inputs.output_format }} \
            --output "$output_file"
          
          echo "âœ… RelatÃ³rio especÃ­fico gerado com sucesso!"

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-${{ github.event.inputs.report_type }}-${{ github.event.inputs.output_format }}
          path: "*.html,*.json"
          retention-days: 30

      - name: Generate Summary
        run: |
          echo "## ðŸ“Š RelatÃ³rio Gerado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.report_type }}" == "todos-usuarios" ]; then
            echo "**ðŸ“‹ Tipo:** RelatÃ³rio Geral (Todos os UsuÃ¡rios)" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ—„ï¸ Escopo:** Sistema completo" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ‘¥ UsuÃ¡rios:** Todos os usuÃ¡rios do sistema" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ðŸ“‹ Tipo:** RelatÃ³rio EspecÃ­fico" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ‘¤ UsuÃ¡rio:** ${{ github.event.inputs.user_email }}" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ github.event.inputs.database_name }}" ]; then
              echo "**ðŸ—„ï¸ Banco:** ${{ github.event.inputs.database_name }}" >> $GITHUB_STEP_SUMMARY
              echo "**ðŸ“‹ Escopo:** Banco especÃ­fico" >> $GITHUB_STEP_SUMMARY
            else
              echo "**ðŸ—„ï¸ Banco:** Todos os bancos do usuÃ¡rio" >> $GITHUB_STEP_SUMMARY
              echo "**ðŸ“‹ Escopo:** Completo do usuÃ¡rio" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "**ðŸ“„ Formato:** ${{ github.event.inputs.output_format }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… Gerado em:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… RelatÃ³rio disponÃ­vel nos artefatos do workflow." >> $GITHUB_STEP_SUMMARY