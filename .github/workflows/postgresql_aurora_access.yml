name: PostgreSQL-Aurora Access Request

on:
  workflow_dispatch:
    inputs:
      engine_type:
        description: "Tipo de Engine"
        required: true
        type: choice
        options: [postgres, aurora]
      ambiente:
        description: "Ambiente"
        required: true
        type: choice
        options: [development, staging, production]
      email:
        description: "Email do usuÃ¡rio (ex: nome@empresa.com)"
        required: true
        type: string
      host:
        description: "Endpoint do banco"
        required: true
        type: string
      database:
        description: "Nome do banco de dados"
        required: true
        type: string
      region:
        description: "RegiÃ£o AWS"
        required: true
        type: string
      port:
        description: "Porta do banco"
        required: true
        default: "5432"
        type: string
      schema:
        description: "Nome do schema (apenas um)"
        required: true
        type: string
      tabelas:
        description: "Nomes das tabelas (separadas por vÃ­rgula) - deixe vazio para aplicar no schema inteiro"
        required: false
        type: string
      perm_select:
        description: "SELECT - Consultar dados"
        required: false
        default: false
        type: boolean
      perm_insert:
        description: "INSERT - Inserir dados"
        required: false
        default: false
        type: boolean
      perm_update:
        description: "UPDATE - Atualizar dados"
        required: false
        default: false
        type: boolean
      perm_delete:
        description: "DELETE - Deletar dados"
        required: false
        default: false
        type: boolean
      perm_truncate:
        description: "TRUNCATE - Truncar tabelas"
        required: false
        default: false
        type: boolean
      perm_references:
        description: "REFERENCES - Criar chaves estrangeiras"
        required: false
        default: false
        type: boolean
      perm_trigger:
        description: "TRIGGER - Criar triggers"
        required: false
        default: false
        type: boolean
      perm_usage:
        description: "USAGE - Usar schema"
        required: false
        default: false
        type: boolean
      perm_execute:
        description: "EXECUTE - Executar funÃ§Ãµes"
        required: false
        default: false
        type: boolean
      perm_create:
        description: "CREATE - Criar objetos"
        required: false
        default: false
        type: boolean
      perm_temp:
        description: "TEMP - Criar tabelas temporÃ¡rias"
        required: false
        default: false
        type: boolean
      perm_all:
        description: "ALL PRIVILEGES - Todas as permissÃµes"
        required: false
        default: false
        type: boolean
      revogar:
        description: "Revogar permissÃµes (deletar YAML)?"
        required: false
        default: false
        type: boolean
      remover_permissoes:
        description: "Remover apenas permissÃµes informadas?"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: write

jobs:
  # ValidaÃ§Ã£o de seguranÃ§a obrigatÃ³ria ANTES de qualquer operaÃ§Ã£o
  security-validation:
    name: ğŸ›¡ï¸ ValidaÃ§Ã£o de SeguranÃ§a
    uses: ./.github/workflows/reusable-security-check.yml
    with:
      workflow_name: "PostgreSQL Aurora Access Request"
      operation_type: "postgresql"

  # Job principal - sÃ³ executa se a validaÃ§Ã£o de seguranÃ§a passar
  process-postgresql-aurora-access:
    name: ğŸ˜ Processar Acesso PostgreSQL Aurora
    runs-on: ubuntu-24.04
    environment: ${{ github.event.inputs.ambiente }}
    timeout-minutes: 10
    
    # DEPENDÃŠNCIA OBRIGATÃ“RIA da validaÃ§Ã£o de seguranÃ§a
    needs: security-validation
    if: needs.security-validation.outputs.is_secure == 'true'

    steps:
      - name: Security Confirmation
        run: |
          echo "ğŸ›¡ï¸ VALIDAÃ‡ÃƒO DE SEGURANÃ‡A APROVADA"
          echo "================================="
          echo "ğŸ¯ Status: ${{ needs.security-validation.outputs.security_status }}"
          echo "ğŸ”“ Prosseguindo com operaÃ§Ãµes PostgreSQL Aurora seguras..."
          echo ""

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Validate Input
        run: |
          echo "ğŸ” Validando entrada para ${{ github.event.inputs.engine_type }}..."
          
          # Validar email
          if ! echo "${{ github.event.inputs.email }}" | grep -E '^[^@]+@[^@]+\.[^@]+$'; then
            echo "âŒ Email invÃ¡lido"
            exit 1
          fi
          
          # Validar porta
          if ! echo "${{ github.event.inputs.port }}" | grep -E '^[0-9]+$'; then
            echo "âŒ Porta deve ser numÃ©rica"
            exit 1
          fi
          
          # Verificar se pelo menos uma permissÃ£o foi selecionada (exceto para revogaÃ§Ã£o)
          if [ "${{ github.event.inputs.revogar }}" != "true" ]; then
            selected_permissions=0
            [ "${{ github.event.inputs.perm_select }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_insert }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_update }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_delete }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_truncate }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_references }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_trigger }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_usage }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_execute }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_create }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_temp }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            [ "${{ github.event.inputs.perm_all }}" == "true" ] && selected_permissions=$((selected_permissions + 1))
            
            if [ $selected_permissions -eq 0 ]; then
              echo "âŒ Pelo menos uma permissÃ£o deve ser selecionada"
              exit 1
            fi
          fi
          
          echo "âœ… ValidaÃ§Ã£o concluÃ­da"

      - name: Install Python Dependencies
        run: pip install pyyaml

      - name: Fetch Credentials from Parameter Store
        id: fetch_credentials
        run: |
          echo "ğŸ” Buscando credenciais no Parameter Store..."
          
          config=$(aws ssm get-parameter \
            --name "rds-access-control" \
            --with-decryption \
            --query Parameter.Value \
            --output text)

          db_key="${{ github.event.inputs.database }}-${{ github.event.inputs.engine_type }}"
          user=$(echo "$config" | grep "^${db_key}-user=" | cut -d'=' -f2-)
          pass=$(echo "$config" | grep "^${db_key}-password=" | cut -d'=' -f2-)

          if [ -z "$user" ] || [ -z "$pass" ]; then
            echo "âŒ Credenciais nÃ£o encontradas para ${db_key}"
            exit 1
          fi

          echo "::add-mask::$user"
          echo "::add-mask::$pass"

          echo "DB_USER=$user" >> $GITHUB_ENV
          echo "DB_PASS=$pass" >> $GITHUB_ENV

      - name: Build Permissions JSON
        id: build_json
        run: |
          echo "ğŸ”§ Construindo JSON de permissÃµes..."
          
          # Construir array de permissÃµes
          permissions="["
          first=true
          
          [ "${{ github.event.inputs.perm_select }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"SELECT\""
            first=false
          }
          [ "${{ github.event.inputs.perm_insert }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"INSERT\""
            first=false
          }
          [ "${{ github.event.inputs.perm_update }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"UPDATE\""
            first=false
          }
          [ "${{ github.event.inputs.perm_delete }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"DELETE\""
            first=false
          }
          [ "${{ github.event.inputs.perm_truncate }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"TRUNCATE\""
            first=false
          }
          [ "${{ github.event.inputs.perm_references }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"REFERENCES\""
            first=false
          }
          [ "${{ github.event.inputs.perm_trigger }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"TRIGGER\""
            first=false
          }
          [ "${{ github.event.inputs.perm_usage }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"USAGE\""
            first=false
          }
          [ "${{ github.event.inputs.perm_execute }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"EXECUTE\""
            first=false
          }
          [ "${{ github.event.inputs.perm_create }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"CREATE\""
            first=false
          }
          [ "${{ github.event.inputs.perm_temp }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"TEMP\""
            first=false
          }
          [ "${{ github.event.inputs.perm_all }}" == "true" ] && {
            [ "$first" == "false" ] && permissions="$permissions,"
            permissions="$permissions\"ALL PRIVILEGES\""
            first=false
          }
          
          permissions="$permissions]"
          
          # Verificar se Ã© granular (tabelas especÃ­ficas) ou schema completo
          if [ -n "${{ github.event.inputs.tabelas }}" ]; then
            # Granular - construir array de tabelas
            echo "ğŸ“Š Modo granular - tabelas especÃ­ficas"
            tables_array="["
            IFS=',' read -ra TABLES <<< "${{ github.event.inputs.tabelas }}"
            first_table=true
            for table in "${TABLES[@]}"; do
              table=$(echo "$table" | xargs) # Remover espaÃ§os em branco
              [ "$first_table" == "false" ] && tables_array="$tables_array,"
              tables_array="$tables_array{\"nome\":\"$table\",\"permissions\":$permissions}"
              first_table=false
            done
            tables_array="$tables_array]"
            
            json="[{\"nome\":\"${{ github.event.inputs.schema }}\",\"tipo\":\"granular\",\"tabelas\":$tables_array}]"
          else
            # Schema completo
            echo "ğŸ“‹ Modo schema completo"
            json="[{\"nome\":\"${{ github.event.inputs.schema }}\",\"permissions\":$permissions}]"
          fi
          
          echo "JSON gerado: $json"
          echo "schemas_json=$json" >> $GITHUB_OUTPUT

      - name: Setup File Paths
        id: setup
        run: |
          # Nova estrutura: ambiente/engine/database/usuario.yml
          user_email="${{ github.event.inputs.email }}"
          database="${{ github.event.inputs.database }}"
          environment="${{ github.event.inputs.ambiente }}"
          engine="${{ github.event.inputs.engine_type }}"
          
          # Criar estrutura de diretÃ³rios
          directory="users-access-requests/${environment}/${engine}/${database}"
          file_path="${directory}/${user_email}.yml"
          
          # Nome da branch
          username="$(echo ${user_email} | cut -d '@' -f1)"
          branch_name="${engine}-access-${username}-${database}-$(date +%s)"
          
          echo "directory=$directory" >> $GITHUB_OUTPUT
          echo "file_path=$file_path" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "user_email=$user_email" >> $GITHUB_OUTPUT
          echo "engine=$engine" >> $GITHUB_OUTPUT

      - name: Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Revoke Access
        if: ${{ github.event.inputs.revogar == 'true' }}
        run: |
          file_path="${{ steps.setup.outputs.file_path }}"
          if [ -f "$file_path" ]; then
            git rm "$file_path"
            git commit -m "ğŸ—‘ï¸ ${{ steps.setup.outputs.engine }}: Revogar acesso do usuÃ¡rio ${{ steps.setup.outputs.user_email }} no banco ${{ github.event.inputs.database }}"
            echo "âœ… Arquivo removido: $file_path"
          else
            echo "âš ï¸ Arquivo nÃ£o encontrado: $file_path"
            echo "â„¹ï¸ UsuÃ¡rio pode nÃ£o ter permissÃµes neste banco ou jÃ¡ foi revogado"
          fi

      - name: Generate or Update YAML
        if: ${{ github.event.inputs.revogar != 'true' }}
        env:
          INPUT_HOST: ${{ github.event.inputs.host }}
          INPUT_EMAIL: ${{ github.event.inputs.email }}
          INPUT_DATABASE: ${{ github.event.inputs.database }}
          INPUT_ENGINE: ${{ github.event.inputs.engine_type }}
          INPUT_REGION: ${{ github.event.inputs.region }}
          INPUT_PORT: ${{ github.event.inputs.port }}
          REMOVER_PERMISSOES: ${{ github.event.inputs.remover_permissoes }}
        run: |
          echo "ğŸ”§ Processando permissÃµes ${{ github.event.inputs.engine_type }}..."
          echo "ğŸ“ Estrutura: ${{ steps.setup.outputs.directory }}"
          echo "ğŸ“„ Arquivo: ${{ steps.setup.outputs.file_path }}"
          
          # Verificar se diretÃ³rio existe
          if [ ! -d "${{ steps.setup.outputs.directory }}" ]; then
            echo "ğŸ—ï¸ Criando nova estrutura de diretÃ³rios: ${{ steps.setup.outputs.directory }}"
            mkdir -p "${{ steps.setup.outputs.directory }}"
          else
            echo "ğŸ“‚ DiretÃ³rio jÃ¡ existe: ${{ steps.setup.outputs.directory }}"
          fi
          
          # Verificar se arquivo existe
          if [ -f "${{ steps.setup.outputs.file_path }}" ]; then
            echo "ğŸ“ Atualizando arquivo existente: ${{ steps.setup.outputs.file_path }}"
          else
            echo "ğŸ†• Criando novo arquivo: ${{ steps.setup.outputs.file_path }}"
          fi
          
          # Processar permissÃµes usando script (que tambÃ©m cria diretÃ³rios se necessÃ¡rio)
          python3 scripts/merge_permissions.py "${{ steps.setup.outputs.file_path }}" '${{ steps.build_json.outputs.schemas_json }}'
          
          # Adicionar ao Git
          git add "${{ steps.setup.outputs.file_path }}"
          
          # Commit com mensagem apropriada
          if [ "${{ github.event.inputs.remover_permissoes }}" == "true" ]; then
            git commit -m "â– ${{ steps.setup.outputs.engine }}: Remover permissÃµes do usuÃ¡rio ${{ steps.setup.outputs.user_email }} no banco ${{ github.event.inputs.database }}"
          else
            git commit -m "â• ${{ steps.setup.outputs.engine }}: Atualizar acesso do usuÃ¡rio ${{ steps.setup.outputs.user_email }} no banco ${{ github.event.inputs.database }}"
          fi
          
          echo "âœ… Arquivo processado com sucesso!"

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          branch: ${{ steps.setup.outputs.branch_name }}
          base: main
          title: "${{ github.event.inputs.engine_type == 'postgres' && 'ğŸ˜' || 'ğŸŒŸ' }} ${{ github.event.inputs.engine_type }}: Acesso para ${{ github.event.inputs.email }}"
          body: |
            ## ${{ github.event.inputs.engine_type == 'postgres' && 'ğŸ˜ PostgreSQL' || 'ğŸŒŸ Aurora' }} - SolicitaÃ§Ã£o de Acesso
            
            **ğŸ“‹ InformaÃ§Ãµes:**
            - ğŸ‘¤ **UsuÃ¡rio:** `${{ github.event.inputs.email }}`
            - ğŸŒ **Ambiente:** `${{ github.event.inputs.ambiente }}`
            - âš™ï¸ **Engine:** `${{ github.event.inputs.engine_type }}`
            - ğŸ—„ï¸ **Banco:** `${{ github.event.inputs.database }}`
            - ğŸ”Œ **Host:** `${{ github.event.inputs.host }}`
            - ğŸšª **Porta:** `${{ github.event.inputs.port }}`
            - ğŸŒ **RegiÃ£o:** `${{ github.event.inputs.region }}`
            
            **ğŸ¯ PermissÃµes Solicitadas:**
            - ğŸ“ **Schema:** `${{ github.event.inputs.schema }}`
            ${{ github.event.inputs.tabelas != '' && format('- ğŸ“Š **Tabelas:** `{0}` (granular)', github.event.inputs.tabelas) || '- ğŸ“‹ **Escopo:** Schema completo' }}
            
            **ğŸ”‘ PermissÃµes:**
            ${{ github.event.inputs.perm_select == 'true' && '- âœ… SELECT (consultar dados)' || '' }}
            ${{ github.event.inputs.perm_insert == 'true' && '- âœ… INSERT (inserir dados)' || '' }}
            ${{ github.event.inputs.perm_update == 'true' && '- âœ… UPDATE (atualizar dados)' || '' }}
            ${{ github.event.inputs.perm_delete == 'true' && '- âœ… DELETE (deletar dados)' || '' }}
            ${{ github.event.inputs.perm_truncate == 'true' && '- âœ… TRUNCATE (truncar tabelas)' || '' }}
            ${{ github.event.inputs.perm_references == 'true' && '- âœ… REFERENCES (chaves estrangeiras)' || '' }}
            ${{ github.event.inputs.perm_trigger == 'true' && '- âœ… TRIGGER (criar triggers)' || '' }}
            ${{ github.event.inputs.perm_usage == 'true' && '- âœ… USAGE (usar schema)' || '' }}
            ${{ github.event.inputs.perm_execute == 'true' && '- âœ… EXECUTE (executar funÃ§Ãµes)' || '' }}
            ${{ github.event.inputs.perm_create == 'true' && '- âœ… CREATE (criar objetos)' || '' }}
            ${{ github.event.inputs.perm_temp == 'true' && '- âœ… TEMP (tabelas temporÃ¡rias)' || '' }}
            ${{ github.event.inputs.perm_all == 'true' && '- âœ… ALL PRIVILEGES (todas as permissÃµes)' || '' }}
            
            **ğŸ¯ Tipo de OperaÃ§Ã£o:**
            ${{ github.event.inputs.revogar == 'true' && 'ğŸ—‘ï¸ **REVOGAÃ‡ÃƒO TOTAL**' || github.event.inputs.remover_permissoes == 'true' && 'â– **REMOÃ‡ÃƒO PARCIAL**' || 'â• **ADIÃ‡ÃƒO/ATUALIZAÃ‡ÃƒO**' }}
            
            **ğŸ” JSON Gerado:**
            ```json
            ${{ steps.build_json.outputs.schemas_json }}
            ```
            
            ---
            **âš ï¸ Importante:** ApÃ³s o merge, as permissÃµes serÃ£o aplicadas automaticamente no ${{ github.event.inputs.engine_type }}.
          commit-message: "feat: ${{ github.event.inputs.engine_type == 'postgres' && 'ğŸ˜' || 'ğŸŒŸ' }} ${{ github.event.inputs.engine_type }} acesso para ${{ github.event.inputs.email }}"
          delete-branch: false

      - name: Show Results
        run: |
          echo "ğŸ‰ Pull Request criado com sucesso!"
          echo "ğŸ”— URL: ${{ steps.create_pr.outputs.pull-request-url }}"
          echo ""
          echo "ğŸ“‹ Resumo ${{ github.event.inputs.engine_type }}:"
          echo "  ğŸ‘¤ UsuÃ¡rio: ${{ github.event.inputs.email }}"
          echo "  ğŸŒ Ambiente: ${{ github.event.inputs.ambiente }}"
          echo "  âš™ï¸ Engine: ${{ github.event.inputs.engine_type }}"
          echo "  ğŸ—„ï¸ Banco: ${{ github.event.inputs.database }}"
          echo "  ğŸ“ Schema: ${{ github.event.inputs.schema }}"
          echo "  ğŸ“Š Tabelas: ${{ github.event.inputs.tabelas || 'Schema completo' }}"
          echo ""
          echo "â³ Aguardando aprovaÃ§Ã£o e merge..."
